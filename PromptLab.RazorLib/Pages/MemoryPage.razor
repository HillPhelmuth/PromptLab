@page "/memory"
@using Microsoft.SemanticKernel.Memory
@using PromptFlowEvalsAsPlugins
<RadzenTabs>
	<Tabs>
		<RadzenTabsItem Text="Memory Search">
			<RadzenRow>
				<RadzenColumn Size="4">
					<RadzenCard>
						<RadzenTemplateForm Data=_memorySearchForm TItem="MemorySearchForm" Submit="Submit">
							<RadzenFormField Text="Search" Style="width:100%">
								<ChildContent>
									<RadzenTextArea Style="width:100%; height:4rem" Name="Search" @bind-Value=_memorySearchForm.SearchText></RadzenTextArea>
								</ChildContent>
							</RadzenFormField>
							<RadzenFormField Text="Count">
								<ChildContent>
									<RadzenNumeric @bind-Value=_memorySearchForm.Count Step="1" Min="0" Max="500"></RadzenNumeric>
								</ChildContent>
								<Helper>
									<RadzenText TextStyle="TextStyle.Caption" Text="Max number of results"></RadzenText>
								</Helper>
							</RadzenFormField>
							<RadzenFormField Text="Count">
								<ChildContent>
									<RadzenNumeric @bind-Value=_memorySearchForm.MinThreshold Step=".01" Min="0" Max="1"></RadzenNumeric>
								</ChildContent>
								<Helper>
									<RadzenText TextStyle="TextStyle.Caption" Text="Minimum cosine similarity"></RadzenText>
								</Helper>
							</RadzenFormField><br />
							<RadzenButton ButtonType="ButtonType.Submit" Text="Search"></RadzenButton>
							<RadzenButton Text="Get All" Click="GetAll"></RadzenButton>
							<RadzenButton Text="Create Question Batch" Click="CreateQuestionBatch" ButtonStyle="ButtonStyle.Secondary"></RadzenButton>
							<RadzenButton Text="Create Answer Batch" Click="CreateAnswerBatch" ButtonStyle="ButtonStyle.Secondary"></RadzenButton>
						</RadzenTemplateForm>
					</RadzenCard>
					@if (_batchlines.Count > 0)
					{
						<RadzenText TextStyle="TextStyle.DisplayH5" TextAlign="TextAlign.Center">BatchLines: @_batchlines.Count</RadzenText>
					}
					@if (_questions.Count > 0)
					{
						<RadzenCard Style="height:25rem; overflow:auto">
							@foreach (var question in _questions)
							{
								<RadzenText>@(_questions.IndexOf(question)) - @question</RadzenText>
							}
						</RadzenCard>
					}
				</RadzenColumn>
				<RadzenColumn Size="4">
					<RadzenText Text="text-embedding-3-small" TextAlign="TextAlign.Center" TextStyle="TextStyle.Subtitle1"></RadzenText>
					<RadzenDataGrid @ref=_grid AllowFiltering=true FilterCaseSensitivity=FilterCaseSensitivity.CaseInsensitive AllowSorting=true AllowPaging=true PageSize=20 Density="Density.Compact" ShowPagingSummary="true" TItem="MemoryQueryResult" Data=_memoryQueryResults>
						<Template Context="result">
							<RadzenCard Style="word-wrap: break-word; overflow-wrap: break-word;width:100%;white-space: pre-wrap;max-height:18rem;overflow:auto;">
								@* <RadzenText Text="@result.Metadata.Id" TextAlign="TextAlign.Center" TextStyle="TextStyle.Overline"></RadzenText> *@

								@((MarkupString)AsHtml(result.Metadata.Text))
							</RadzenCard>
						</Template>
						<Columns>
							<RadzenDataGridColumn TItem="MemoryQueryResult" Title="Id" Property="Metadata.Id"></RadzenDataGridColumn>
							<RadzenDataGridColumn TItem="MemoryQueryResult" Title="Name" Property="Metadata.Description"></RadzenDataGridColumn>
							<RadzenDataGridColumn TItem="MemoryQueryResult" Title="Relevance" Property="Relevance">
								<Template Context="item">
									@item.Relevance.ToString("P2")
								</Template>
							</RadzenDataGridColumn>
						</Columns>
					</RadzenDataGrid>
				</RadzenColumn>
				<RadzenColumn Size="4">
					<RadzenText Text="text-embedding-3-large" TextAlign="TextAlign.Center" TextStyle="TextStyle.Subtitle1"></RadzenText>
					<RadzenDataGrid @ref=_grid2 AllowFiltering=true FilterCaseSensitivity=FilterCaseSensitivity.CaseInsensitive AllowSorting=true AllowPaging=true PageSize=20 Density="Density.Compact" ShowPagingSummary="true" TItem="MemoryQueryResult" Data=_memoryQueryResultsEnhanced>
						<Template Context="result">
							<RadzenCard Style="word-wrap: break-word; overflow-wrap: break-word;width:100%;white-space: pre-wrap;max-height:18rem;overflow:auto;">
								@* <RadzenText Text="@result.Metadata.Id" TextAlign="TextAlign.Center" TextStyle="TextStyle.Overline"></RadzenText> *@

								@((MarkupString)AsHtml(result.Metadata.Text))
							</RadzenCard>
						</Template>
						<Columns>
							<RadzenDataGridColumn TItem="MemoryQueryResult" Title="Id" Property="Metadata.Id"></RadzenDataGridColumn>
							<RadzenDataGridColumn TItem="MemoryQueryResult" Title="Name" Property="Metadata.Description"></RadzenDataGridColumn>
							<RadzenDataGridColumn TItem="MemoryQueryResult" Title="Relevance" Property="Relevance">
								<Template Context="item">
									@item.Relevance.ToString("P2")
								</Template>
							</RadzenDataGridColumn>
						</Columns>
					</RadzenDataGrid>
				</RadzenColumn>
			</RadzenRow>
		</RadzenTabsItem>
		<RadzenTabsItem Text="Memory Save">
			<RadzenRow>
				<RadzenColumn Size="4">
					<RadzenCard>
						<RadzenButton Text="Save With Images" Click=SaveAllNew IsBusy=_isBusy BusyText="Saving..."></RadzenButton>
						<RadzenButton Text="Cancel" Click=Cancel></RadzenButton>
					</RadzenCard>
				</RadzenColumn>
				<RadzenColumn Size="8">
					<RadzenText Text="Logs" TextAlign="TextAlign.Center"></RadzenText>
					<RadzenCard Style="height:75vh; overflow:auto; background-color:black; color:white">
						@foreach (var log in _logs)
						{
							@((MarkupString)AsHtml(log))
						}
					</RadzenCard>
				</RadzenColumn>
			</RadzenRow>
		</RadzenTabsItem>
		<RadzenTabsItem Text="Evals">
			<RadzenRow>
				<RadzenColumn Size="5">
					
					<RadzenButton Text="Run Evals" Size=ButtonSize.ExtraSmall Style="margin-left:25%" Click="@(() => GetEvalsResults())" IsBusy=_isEval BusyText="Evaluating..."></RadzenButton>
					<RadzenButton Text="Get Non-hyde" Size=ButtonSize.ExtraSmall Click="GetAllInputModels" IsBusy=_isBusy BusyText="Generating Inputs..."></RadzenButton>
					<RadzenCard>
						
						<RadzenDataGrid @ref=_InputNonHydeGrid Data="_inputModels.Where(x => !x.IsHyde)" TItem="InputModelDisplay" AllowSorting=true Density="Density.Compact" AllowPaging=true PageSize="12" ShowPagingSummary=true>
							<Columns>
								<RadzenDataGridColumn TItem=InputModelDisplay Title="Func" Property="InputModel.FunctionName" Width="25%"></RadzenDataGridColumn>
								@* <RadzenDataGridColumn TItem=InputModelDisplay Title="Is Hyde" Property="@(nameof(InputModelDisplay.IsHyde))"></RadzenDataGridColumn> *@
								<RadzenDataGridColumn TItem=InputModelDisplay Title="Question" Sortable=false Width="75%">
									<Template Context="ctx">
										@if (ctx.InputModel.RequiredInputs.Any(x => x.Key == "question"))
										{
											<RadzenText TextStyle="TextStyle.Body2" Text="@ctx.InputModel.RequiredInputs["question"]?.ToString()"></RadzenText>
										}

									</Template>
								</RadzenDataGridColumn>
							</Columns>
						</RadzenDataGrid>
					</RadzenCard>
					<RadzenCard>						
						<RadzenDataGrid @ref=_InputHydeGrid Data="_inputModels.Where(x => x.IsHyde)" TItem="InputModelDisplay" AllowSorting=true Density="Density.Compact" AllowPaging=true PageSize="12" ShowPagingSummary=true>
							<Columns>
								<RadzenDataGridColumn TItem=InputModelDisplay Title="Func" Property="InputModel.FunctionName" Width="25%"></RadzenDataGridColumn>
								@* <RadzenDataGridColumn TItem=InputModelDisplay Title="Is Hyde" Property="@(nameof(InputModelDisplay.IsHyde))"></RadzenDataGridColumn> *@
								<RadzenDataGridColumn TItem=InputModelDisplay Title="Question" Sortable=false Width="75%">
									<Template Context="ctx">
										@if (ctx.InputModel.RequiredInputs.Any(x => x.Key == "question"))
										{
											<RadzenText TextStyle="TextStyle.Body2" Text="@ctx.InputModel.RequiredInputs["question"]?.ToString()"></RadzenText>
										}

									</Template>
								</RadzenDataGridColumn>
							</Columns>
						</RadzenDataGrid>
					</RadzenCard>
				</RadzenColumn>
				<RadzenColumn Size="7">
					@if (_evalResults.Count > 0)
					{
						<EvalDisplay @ref=_evalDisplay EvalResultDisplays="_evalResults" AggregatedResults="_resultsAgg" Header="Non-Hyde Results"></EvalDisplay>
					}
					@if (_hydeEvalResults.Count > 0)
					{
						<EvalDisplay @ref=_evalDisplayHyde EvalResultDisplays="_hydeEvalResults" AggregatedResults="_resultsAggHyde" Header="Hyde Results"></EvalDisplay>
					}
				</RadzenColumn>
			</RadzenRow>
		</RadzenTabsItem>
	</Tabs>
</RadzenTabs>
